function loadAndRenderGeoJSON(showOnlyWithImages = false, ward = "", architect = "", startYear = null, endYear = null) {
  fetch("https://raw.githubusercontent.com/ejac3/wardman_homes/main/wardman_buildings.geojson")
    .then((res) => res.json())
    .then((data) => {
      console.log("✅ GeoJSON loaded, total features:", data.features.length);

      if (geojsonLayer) {
        map.removeLayer(geojsonLayer);
      }

      const filteredData = {
        type: "FeatureCollection",
        features: data.features.filter(feature => {
          const p = feature.properties;
          if (!p) return false;

          if (showOnlyWithImages && !(p.image_folder && Array.isArray(p.image_files) && p.image_files.length > 0)) {
            return false;
          }

          if (ward && p.WARD !== ward) return false;

          if (architect && (!p.architect || !p.architect.toLowerCase().includes(architect))) return false;

          let permitYear = null;
          if (p.permit_date && typeof p.permit_date === "string" && p.permit_date.includes("/")) {
            const parts = p.permit_date.split("/");
            if (parts.length === 3 && !isNaN(parts[2])) {
              permitYear = parseInt(parts[2]);
            }
          }

          if ((startYear && (!permitYear || permitYear < startYear)) ||
              (endYear && (!permitYear || permitYear > endYear))) {
            return false;
          }

          return true;
        })
      };

      console.log("✅ Filtered features:", filteredData.features.length);

      geojsonLayer = L.geoJSON(filteredData, {
        pointToLayer: function (feature, latlng) {
          const ward = feature.properties.WARD;
          const color = getWardColor(ward);
          return L.circleMarker(latlng, {
            radius: 6,
            fillColor: color,
            color: "#333",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8,
          });
        },
        onEachFeature: function (feature, layer) {
          const p = feature.properties;
          let popupContent = `
            <strong>${p.address || p.ADDRESS || "Unknown Address"}</strong><br>
            ${p.description || ""}<br>
            Architect: ${p.architect || "N/A"}<br>
            Permit Date: ${p.permit_date || "N/A"}<br>
            MAR ID: ${p.MAR_ID || "N/A"}<br>
            Ward: ${p.WARD || "N/A"}<br>
            Square: ${p.SQUARE || "N/A"} Lot: ${p.LOT || "N/A"}<br>
            ${p.STREET_VIEW_URL ? `<a href="${p.STREET_VIEW_URL}" target="_blank">Street View</a><br>` : ""}
          `;

          if (p.image_folder && p.image_files && Array.isArray(p.image_files)) {
            popupContent += `<br><em>Images:</em><br>`;
            p.image_files.forEach(filename => {
              const url = `https://raw.githubusercontent.com/ejac3/wardman_homes/main/Wardman_images/${p.image_folder}/${filename}`;
              popupContent += `
                <a href="${url}" target="_blank">
                  <img src="${url}" width="100" style="margin: 2px;">
                </a>
              `;
            });
          }

          layer.bindPopup(popupContent);
        }
      }).addTo(map);
    });
}
